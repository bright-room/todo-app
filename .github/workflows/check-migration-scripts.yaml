---
name: "Check migration scripts"
"on":
  pull_request:
    paths:
    - "backend/infrastructure/schemas/src/main/kotlin/net/brightroom/schemas/schema/**"
jobs:
  check-migration:
    runs-on: "ubuntu-latest"
    timeout-minutes: 10
    steps:
    - name: "Checkout Repository"
      uses: "actions/checkout@v5"
    - name: "Docker Compose up"
      run: "docker compose up -d"
    - name: "Gradle Cache"
      uses: "./.github/actions/gradle-cache"
    - name: "Execute Migration Script"
      uses: "./.github/actions/gradle-action"
      with:
        command: ":backend:infrastructure:migration:executor:bootRun"
    - name: "Generate Migration Script"
      uses: "./.github/actions/gradle-action"
      with:
        command: ":backend:infrastructure:migration:generator:bootRun"
    - name: "Docker Compose down"
      run: "docker compose down -v"
    - name: "Count changes"
      id: "changes"
      run: "git add -N .\ncount=$(git diff --name-only | grep '^backend/infrastructure/schemas/src/main/kotlin/net/brightroom/schemas/schema/'\
        \ | wc -l)\necho \"count=$count\" >> $GITHUB_OUTPUT\n"
    - name: "Fail if migration scripts are missing in PR"
      if: "steps.changes.outputs.count != '0'"
      run: "echo \"‚ùå Migration scripts have been generated but not committed.\"\n\
        echo \"Please run the generator locally and commit the migration files.\"\n\
        exit 1\n"
