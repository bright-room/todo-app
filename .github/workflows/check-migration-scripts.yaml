---
name: "Check migration scripts"

"on":
  pull_request:
    paths:
      - "backend/infrastructure/schemas/src/main/kotlin/net/brightroom/schemas/schema/**"
      - "backend/infrastructure/migration/executor/src/main/resources/migration/**"

jobs:
  check-migration:
    runs-on: "ubuntu-latest"
    timeout-minutes: 10

    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v5"

      - name: "Docker Compose up"
        run: "docker compose up -d"

      - name: "Restore gradle caches"
        uses: "./.github/actions/gradle-cache"

      - name: "Generate migration script"
        uses: "./.github/actions/gradle-action"
        with:
          command: ":backend:infrastructure:migration:generator:bootRun"

      - name: "Docker Compose down"
        run: "docker compose down -v"

      - name: "Fail if migration scripts are missing in PR"
        run: |
          git add -N .
          changes=$(git diff --name-only | grep '^backend/infrastructure/migration/executor/src/main/resources/migration/' || true)

          if [ -n "$changes" ]; then
            echo "❌ Migration scripts have been generated but not committed:"
            echo "result: $changes"
            echo "Please run the generator locally and commit the migration files."
            exit 1
          else
            echo "✅ No uncommitted migration scripts found."
          fi
